<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Torre Eiffel - Controle Real</title>
    
    <link rel="icon" type="image/png" href="imagens/favcon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- CSS CUSTOMIZADO --- */
        body, html { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #050505; 
            font-family: 'Segoe UI', sans-serif; color: white; 
            height: 100%;
            transition: background 0.5s ease;
        }
        
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Footer */
        #copyright-footer {
            position: fixed; bottom: 10px; left: 10px; z-index: 5;
            color: #666; font-size: 0.65rem; font-family: monospace;
            pointer-events: none; user-select: none;
        }
        
        /* UI Principal */
        #ui-layer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 10; pointer-events: none;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        #ui-layer.hidden-ui { transform: translateY(calc(100% - 40px)); }
        
        /* Painel Interativo */
        .interactive-area { 
            pointer-events: auto; background: rgba(20,20,20,0.9); padding: 20px; padding-top: 10px; 
            border-radius: 20px 20px 0 0; border: 1px solid #333; border-bottom: none;
            backdrop-filter: blur(10px); box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column; align-items: center; 
            min-width: 350px; max-width: 95%; max-height: 70vh; 
            overflow-y: auto; scrollbar-width: thin; scrollbar-color: #555 #1a1a1a;
        }
        
        /* Scrollbar */
        .interactive-area::-webkit-scrollbar { width: 6px; }
        .interactive-area::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        .interactive-area::-webkit-scrollbar-thumb { background-color: #555; border-radius: 3px; }
        
        /* BotÃ£o Toggle (Seta) */
        #toggle-btn { width: 100%; height: 30px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #fbbf24; margin-bottom: 5px; flex-shrink: 0; }
        #arrow-icon { transition: transform 0.4s ease; }
        #ui-layer.hidden-ui #arrow-icon { transform: rotate(180deg); }
        
        /* Header & Status */
        .header-bar { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; flex-shrink: 0; }
        h1 { color: #fbbf24; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; font-weight: bold; margin: 0; }
        
        #connect-status-btn {
            background: transparent; border: 1px solid #555; color: #888;
            font-size: 0.7rem; padding: 4px 8px; border-radius: 6px;
            cursor: pointer; display: flex; align-items: center; gap: 5px;
            transition: all 0.3s; text-transform: uppercase; font-weight: bold;
        }
        #connect-status-btn.connected { border-color: #00ff00; color: #00ff00; background: rgba(0, 255, 0, 0.1); }
        
        /* Grid de Efeitos */
        .effects-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; 
            margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; 
        }
        .effect-btn { 
            background: #333; border: none; border-radius: 8px; color: #ddd; 
            font-size: 0.7rem; padding: 12px 4px; cursor: pointer; 
            text-transform: uppercase; font-weight: bold; transition: 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .effect-btn.active { background: #fbbf24; color: #000; box-shadow: 0 0 10px #fbbf24; }
        
        /* Tela de Login */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(8px);
        }
        .login-box {
            background: #1a1a1a; padding: 30px; border-radius: 20px;
            border: 1px solid #333; text-align: center; width: 90%; max-width: 350px;
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.1); position: relative;
        }
        .login-input {
            width: 100%; padding: 15px; margin: 20px 0; background: #333; 
            border: 1px solid #555; color: white; border-radius: 10px; 
            font-size: 1.2rem; text-align: center; outline: none;
        }
        .login-input:focus { border-color: #fbbf24; }
        .login-btn {
            background: #fbbf24; color: black; font-weight: bold;
            padding: 15px; border-radius: 10px; border: none; width: 100%; cursor: pointer;
        }
        .close-login { position: absolute; top: 10px; right: 15px; color: #666; cursor: pointer; font-size: 1.5rem; }
        
        /* BotÃ£o Audio */
        #audio-toggle-btn {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: rgba(20, 20, 20, 0.8); border: 1px solid #333; 
            color: #fbbf24; cursor: pointer; width: 40px; height: 40px;
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
        }
        #audio-toggle-btn.muted { color: #ff4444; border-color: #ff4444; }

        @media (max-width: 480px) {
            .effects-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/@jaames/iro@5.5.2/dist/iro.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

    <audio id="background-audio" preload="auto" loop style="display: none;">
        <source src="Audio/Audio.mp3" type="audio/mpeg">
    </audio>

    <button id="audio-toggle-btn" onclick="toggleAudio()" title="Som">
        <svg id="icon-sound" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a7 7 0 0 1 0 9.9M19.07 4.93a11 11 0 0 1 0 15.66"></path></svg>
    </button>

    <div id="login-screen">
        <div class="login-box">
            <span class="close-login" onclick="closeLogin()">Ã—</span>
            <h1 class="text-xl font-bold text-white mb-2">Controle Real</h1>
            <p id="login-msg" class="text-gray-400 text-sm mb-4">Digite a senha de acesso.</p>
            <div style="position: relative; margin-bottom: 20px;">
                <input type="password" id="password-input" class="login-input" placeholder="Senha">
            </div>
            <button id="login-action-btn" class="login-btn" onclick="checkPassword()">ACESSAR</button>
            <p id="login-error" class="text-red-500 mt-3 hidden text-sm font-bold">Senha Incorreta!</p>
        </div>
    </div>

    <div id="canvas-container"></div>
    
    <div id="copyright-footer">
        Â© 2025 Julio Cezar & Luiz Merchiori
    </div>
    
    <div id="ui-layer">
        <div class="interactive-area">
            <div id="toggle-btn" onclick="toggleUI()">
                <svg id="arrow-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            
            <div class="header-bar">
                <h1>Torre Eiffel</h1>
                <button id="connect-status-btn" onclick="openLogin()">
                    <span id="conn-icon">ðŸ”’</span> <span id="conn-text">SimulaÃ§Ã£o</span>
                </button>
            </div>

            <div id="color-picker"></div>
            
            <div id="effects-container" class="effects-grid">
                <button class="effect-btn active" onclick="setEffect('solid')" id="btn-solid">Fixa</button>
                <button class="effect-btn" onclick="setEffect('rainbow')" id="btn-rainbow">Rainbow</button>
                <button class="effect-btn" onclick="setEffect('fire')" id="btn-fire">Fogo</button>
                <button class="effect-btn" onclick="setEffect('heartbeat')" id="btn-heartbeat">Batimento</button>
                <button class="effect-btn" onclick="setEffect('pisca')" id="btn-pisca">Pisca</button>
                <button class="effect-btn" onclick="setEffect('disco')" id="btn-disco">Disco</button>
                <button class="effect-btn" onclick="setEffect('fade')" id="btn-fade">Fade</button>
                <button class="effect-btn" onclick="setEffect('thunder')" id="btn-thunder">TrovÃ£o</button>
                <button class="effect-btn" onclick="setEffect('sos')" id="btn-sos">SOS</button>
                <button class="effect-btn" onclick="setEffect('france')" id="btn-france">FranÃ§a</button>
                <button class="effect-btn" onclick="setEffect('brazil')" id="btn-brazil">Brasil</button>
                <button class="effect-btn" onclick="setEffect('aurora')" id="btn-aurora">Aurora</button>
                <button class="effect-btn" onclick="setEffect('xmas')" id="btn-xmas">Natal</button>
                <button class="effect-btn" onclick="setEffect('halloween')" id="btn-halloween">Halloween</button>
                <button class="effect-btn" onclick="setEffect('sunset')" id="btn-sunset">Sunset</button>
                <button class="effect-btn" onclick="setEffect('police')" id="btn-police">PolÃ­cia</button>
                <button class="effect-btn" onclick="setEffect('ice')" id="btn-ice">Gelo</button>
                <button class="effect-btn" onclick="setEffect('candy')" id="btn-candy">Candy</button>
            </div>

            <div id="status-msg" class="text-xs text-gray-500 mt-2 font-mono">Modo: Simulador Local</div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAÃ‡Ã•ES ---
        const MY_PASSWORD = "paladinoseiffel"; 
        const firebaseConfig = {
            apiKey: "SUA_API_KEY", // âš ï¸ INSIRA SUA API KEY AQUI
            authDomain: "SEU_PROJETO.firebaseapp.com",
            databaseURL: "https://SEU_PROJETO-default-rtdb.firebaseio.com",
            projectId: "SEU_PROJETO",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        // VariÃ¡veis Globais
        let database, amITheController = false, keepAliveInterval;
        let scene, camera, renderer, controls, towerMaterial, pointLight;
        let currentEffect = 'solid'; 
        let baseColor = new THREE.Color("#ffaa00"); 
        let colorPicker, flagMesh;
        let lastDiscoChange = 0;
        let globalYAntenna = 75;
        let globalYFlag = 75;

        // --- 2. SISTEMA DE ÃUDIO ---
        function initAudio() {
            const audio = document.getElementById('background-audio');
            if(audio) {
                audio.volume = 0.3;
                // Tentar autoplay, se falhar, aguardar clique
                audio.play().catch(() => {
                    console.log("Autoplay bloqueado. Aguardando interaÃ§Ã£o.");
                    document.addEventListener('click', () => {
                        audio.play().catch(()=>{});
                    }, { once: true });
                });
            }
        }

        function toggleAudio() {
            const audio = document.getElementById('background-audio');
            const btn = document.getElementById('audio-toggle-btn');
            if(audio.paused) {
                audio.play();
                btn.classList.remove('muted');
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a7 7 0 0 1 0 9.9M19.07 4.93a11 11 0 0 1 0 15.66"></path></svg>';
            } else {
                audio.pause();
                btn.classList.add('muted');
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v6a3 3 0 0 0 5.12 2.12M15 9.34V4l-6.81 7.19"></path></svg>';
            }
        }

        // --- 3. FIREBASE & CONTROLE ---
        function initFirebase() {
            if (!firebase.apps.length) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    return true;
                } catch (e) {
                    console.warn("Firebase nÃ£o configurado.");
                    return false;
                }
            }
            database = firebase.database();
            return true;
        }

        function setupSpectatorMode() {
            if (!database) return;
            database.ref('torre/cor').on('value', (snapshot) => {
                if(!amITheController && snapshot.val()) {
                    updateVisuals(snapshot.val());
                    if(colorPicker && colorPicker.color) colorPicker.color.hexString = snapshot.val();
                }
            });
            database.ref('torre/efeito').on('value', (snapshot) => {
                if(!amITheController && snapshot.val()) {
                    currentEffect = snapshot.val();
                    updateUIButtons(currentEffect);
                }
            });
        }

        function openLogin() {
            if(amITheController) return;
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('login-error').classList.add('hidden');
            
            if(initFirebase()) {
                setupSpectatorMode();
                database.ref('torre/status/lastActive').once('value').then(snapshot => {
                    const lastActive = snapshot.val() || 0;
                    const msg = document.getElementById('login-msg');
                    if(Date.now() - lastActive < 15000) {
                        msg.innerText = "Sistema Ocupado. Aguarde.";
                        msg.className = "text-orange-400 text-sm mb-4";
                    } else {
                        msg.innerText = "Sistema Livre.";
                        msg.className = "text-green-400 text-sm mb-4";
                    }
                });
            }
        }

        function closeLogin() {
            document.getElementById('login-screen').style.display = 'none';
        }

        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if(input === MY_PASSWORD) {
                document.getElementById('login-action-btn').innerText = "Verificando...";
                checkAvailabilityAndTakeControl();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function checkAvailabilityAndTakeControl() {
            if(!initFirebase()) { // Modo offline se firebase falhar
                takeControl(); return;
            }
            database.ref('torre/status/lastActive').once('value').then(snapshot => {
                const lastActive = snapshot.val() || 0;
                if (Date.now() - lastActive < 15000) {
                    document.getElementById('login-error').innerText = "Torre Ocupada! Tente depois.";
                    document.getElementById('login-error').classList.remove('hidden');
                    document.getElementById('login-action-btn').innerText = "ACESSAR";
                } else {
                    takeControl();
                }
            });
        }

        function takeControl() {
            amITheController = true;
            closeLogin();
            startKeepAlive();
            
            // UI Update
            const btn = document.getElementById('connect-status-btn');
            btn.className = 'connected';
            btn.innerHTML = '<span id="conn-icon">ðŸ”“</span> <span id="conn-text">Conectado</span>';
            const msg = document.getElementById('status-msg');
            msg.innerText = "Controle Ativo (Sua Vez)";
            msg.className = "text-xs text-green-400 mt-2 font-mono";
        }

        function startKeepAlive() {
            if(database) {
                database.ref('torre/status/lastActive').set(Date.now());
                keepAliveInterval = setInterval(() => {
                    database.ref('torre/status/lastActive').set(Date.now());
                }, 5000);
                window.addEventListener('beforeunload', () => {
                    database.ref('torre/status/lastActive').set(0);
                });
            }
        }

        function toggleUI() { document.getElementById('ui-layer').classList.toggle('hidden-ui'); }

        // --- 4. THREE.JS & GEOMETRIA ---
        function updateBackground(hexColor) {
            document.body.style.background = `radial-gradient(circle at center, ${hexColor}33 0%, #050505 100%)`;
        }

        function updateUIButtons(effectName) {
            document.querySelectorAll('.effect-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.getElementById('btn-' + effectName);
            if(btn) btn.classList.add('active');
            if(!amITheController) {
                document.getElementById('status-msg').innerText = "Simulando: " + effectName.toUpperCase();
            }
        }

        function setEffect(effectName) {
            currentEffect = effectName; 
            updateUIButtons(effectName);
            if(effectName === 'solid') applyColor(baseColor, 0.9, 2);
            
            if(amITheController && database) {
                database.ref('torre/efeito').set(effectName);
                if(effectName === 'solid') database.ref('torre/cor').set("#" + baseColor.getHexString());
                database.ref('torre/status/lastActive').set(Date.now());
            }
        }

        function applyColor(color, opacity, intensity) {
            towerMaterial.color.copy(color); 
            towerMaterial.opacity = opacity;
            pointLight.color.copy(color); 
            pointLight.intensity = intensity;
            updateBackground("#" + color.getHexString());
        }

        function updateVisuals(hexColor) {
            baseColor.set(hexColor);
            if (currentEffect === 'solid') applyColor(baseColor, 0.9, 2);
        }

        function createFlag() {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#002395'; ctx.fillRect(0,0, 85, 128);
            ctx.fillStyle = '#ffffff'; ctx.fillRect(85,0, 86, 128);
            ctx.fillStyle = '#ed2939'; ctx.fillRect(171,0, 85, 128);
            const texture = new THREE.CanvasTexture(canvas);
            const geometry = new THREE.PlaneGeometry(4, 2.5, 15, 10); 
            geometry.translate(2, 0, 0); 
            const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide, transparent: true, opacity: 0.9 });
            flagMesh = new THREE.Mesh(geometry, material);
            flagMesh.position.set(0, globalYFlag, 0); 
            scene.add(flagMesh);
        }

        function createEducationalTower() {
            const group = new THREE.Group();
            const positions = [];
            const addLine = (p1, p2) => positions.push(p1.x, p1.y, p1.z, p2.x, p2.y, p2.z);
            const vec = (x, y, z) => new THREE.Vector3(x, y, z);

            const Y_GND = 0, Y_PLAT1 = 14, Y_PLAT2 = 36, Y_TOP = 68, Y_ANTENNA = 75, Y_FLAG = 75;
            const W_BASE = 22, W_PLAT1 = 10.0, W_PLAT2 = 3.8, W_TOP = 1.0;
            globalYAntenna = Y_ANTENNA;
            globalYFlag = Y_FLAG;

            // 1. Pilares da Base
            const createPillar = (angle) => {
                const steps = 25; let prevP = null;
                for(let i=0; i<=steps; i++) {
                    const t = i/steps;
                    const y = Y_GND + t * Y_PLAT2;
                    const curveFactor = Math.pow(1-t, 2.2);
                    const dist = W_PLAT2 + (W_BASE - W_PLAT2) * curveFactor;
                    const size = 4.5 * (1 - t * 0.6);
                    const cx = Math.cos(angle) * dist, cz = Math.sin(angle) * dist;
                    const corners = [
                        vec(cx+size, y, cz+size), vec(cx-size, y, cz+size),
                        vec(cx-size, y, cz-size), vec(cx+size, y, cz-size)
                    ];
                    if(prevP) for(let k=0; k<4; k++) {
                        addLine(prevP[k], corners[k]);
                        addLine(prevP[k], corners[(k+1)%4]);
                        addLine(prevP[(k+1)%4], corners[k]);
                    }
                    for(let k=0; k<4; k++) addLine(corners[k], corners[(k+1)%4]);
                    prevP = corners;
                }
            };
            [1,3,5,7].forEach(k => createPillar(k * Math.PI/4));

            // 2. Arcos
            const createArch = (isX, sign) => {
                const steps = 20; const archH = Y_PLAT1 * 0.85; let prevP = null;
                for(let i=0; i<=steps; i++) {
                    const t = i/steps, y = Math.sin(t * Math.PI) * archH;
                    const yn = Math.min(y/Y_PLAT2, 1), cf = Math.pow(1-yn, 2.2);
                    const cw = W_PLAT2 + (W_BASE - W_PLAT2) * cf;
                    const span = (t*2-1) * cw;
                    const p = isX ? vec(sign*cw, y, span) : vec(span, y, sign*cw);
                    const pt = isX ? vec(sign*(cw-0.5), y, span) : vec(span, y, sign*(cw-0.5));
                    if(prevP) { addLine(prevP[0], p); addLine(prevP[1], pt); addLine(prevP[0], pt); }
                    prevP = [p, pt];
                }
            };
            createArch(true, 1); createArch(true, -1); createArch(false, 1); createArch(false, -1);

            // 3. Agulha (Spire)
            const createSpire = () => {
                const steps = 40; let prev = null;
                const startD = 2.5, endD = 0.75;
                for(let i=0; i<=steps; i++) {
                    const t = i/steps, y = Y_PLAT2 + t * (Y_TOP - Y_PLAT2);
                    const tc = Math.pow(t, 0.8), d = startD*(1-tc) + endD*tc;
                    const corners = [vec(d,y,d), vec(-d,y,d), vec(-d,y,-d), vec(d,y,-d)];
                    if(prev) for(let k=0; k<4; k++) {
                        addLine(prev[k], corners[k]); addLine(prev[k], corners[(k+1)%4]);
                    }
                    for(let k=0; k<4; k++) addLine(corners[k], corners[(k+1)%4]);
                    prev = corners;
                }
            };
            createSpire();

            // 4. Plataformas
            const createDeck = (y, w, th, step=2) => {
                const h = w; const b = [vec(h,y,h), vec(-h,y,h), vec(-h,y,-h), vec(h,y,-h)];
                const t = [vec(h,y+th,h), vec(-h,y+th,h), vec(-h,y+th,-h), vec(h,y+th,-h)];
                for(let k=0; k<4; k++) {
                    const n = (k+1)%4;
                    addLine(b[k], b[n]); addLine(t[k], t[n]); addLine(b[k], t[k]); addLine(b[k], t[n]); addLine(t[k], b[n]);
                }
                for(let i=-h; i<=h; i+=step) { addLine(vec(i,y,-h), vec(i,y,h)); addLine(vec(-h,y,i), vec(h,y,i)); }
            };
            createDeck(Y_PLAT1, 12.5, 2.5, 0.5); // Plat 1
            createDeck(Y_PLAT2, 4.5, 1.2); // Plat 2

            // Cube at top
            const cubeH = 2.0;
            const cubeY = Y_TOP + cubeH;
            const cubeW = W_TOP + 0.5;
            const topCorners = [vec(W_TOP, Y_TOP, W_TOP), vec(-W_TOP, Y_TOP, W_TOP), vec(-W_TOP, Y_TOP, -W_TOP), vec(W_TOP, Y_TOP, -W_TOP)];
            const cubeCorners = [vec(cubeW, cubeY, cubeW), vec(-cubeW, cubeY, cubeW), vec(-cubeW, cubeY, -cubeW), vec(cubeW, cubeY, -cubeW)];
            for(let k=0; k<4; k++) {
                addLine(topCorners[k], cubeCorners[k]);
                addLine(cubeCorners[k], cubeCorners[(k+1)%4]);
            }
            for(let k=0; k<4; k++) addLine(cubeCorners[k], cubeCorners[(k+1)%4]);

            // 5. Antena & Topo
            const yAnt = cubeY;
            addLine(vec(0, yAnt, 0), vec(0, Y_ANTENNA, 0));

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.computeBoundingBox();
            geometry.translate(0, -Y_PLAT2/2, 0); 

            const mesh = new THREE.LineSegments(geometry, towerMaterial);
            group.add(mesh);
            scene.add(group);
        }

        function init() {
            try {
                initAudio();
                if(firebaseConfig.apiKey !== "SUA_API_KEY") { initFirebase(); setupSpectatorMode(); }

                const container = document.getElementById('canvas-container');
                scene = new THREE.Scene(); 
                scene.fog = new THREE.FogExp2(0x050505, 0.015);
                camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 35, 110); 
                
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight); 
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                container.appendChild(renderer.domElement);
                
                scene.add(new THREE.AmbientLight(0xffffff, 0.3));
                pointLight = new THREE.PointLight(0xffaa00, 2, 80); 
                pointLight.position.set(0, 30, 0); 
                scene.add(pointLight);
                
                towerMaterial = new THREE.LineBasicMaterial({ color: 0xffaa00, linewidth: 1, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending });
                
                createEducationalTower();
                createFlag(); 
                
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true; controls.dampingFactor = 0.05; 
                controls.autoRotate = true; controls.autoRotateSpeed = 1.0; 
                controls.target.set(0, 45, 0); 
                controls.minPolarAngle = 0; controls.maxPolarAngle = Math.PI;
                
                const pickerContainer = document.getElementById('color-picker');
                if(pickerContainer) {
                    colorPicker = new iro.ColorPicker('#color-picker', { width: 220, color: "#ffaa00", borderWidth: 2, borderColor: "#fff", layout: [{ component: iro.ui.Wheel }, { component: iro.ui.Slider, options: { sliderType: 'value' } }] });
                    colorPicker.on('color:change', (color) => {
                        baseColor.set(color.hexString); 
                        if (currentEffect === 'solid') applyColor(baseColor, 0.9, 2);
                        if(amITheController && database) {
                            database.ref('torre/cor').set(color.hexString);
                            database.ref('torre/status/lastActive').set(Date.now());
                        }
                    });
                }
                updateBackground("#ffaa00");
                animate(); 
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            } catch(e) { console.error(e); }
        }

        function animate() {
            requestAnimationFrame(animate);
            if(controls) controls.update();
            const now = Date.now();

            if (currentEffect === 'rainbow') {
                const hue = (now % 4000) / 4000; applyColor(new THREE.Color().setHSL(hue, 1, 0.5), 0.9, 2);
            } else if (currentEffect === 'fire') {
                const flicker = Math.random() * 0.1; applyColor(new THREE.Color().setHSL(flicker, 1, 0.5), 0.8 + Math.random()*0.2, 1+Math.random());
            } else if (currentEffect === 'heartbeat') {
                const beat = (now % 1200) / 1200; let pulse = 0;
                if(beat < 0.2) pulse = Math.sin(beat * Math.PI * 5); else if(beat > 0.3 && beat < 0.5) pulse = Math.sin((beat-0.3) * Math.PI * 5) * 0.6; 
                applyColor(baseColor, 0.3 + pulse * 0.7, 0.5 + pulse * 2.5);
            } else if (currentEffect === 'pisca') {
                const isOn = Math.floor(now / 100) % 2 === 0; applyColor(baseColor, isOn ? 1 : 0.1, isOn ? 3 : 0);
            } else if (currentEffect === 'disco') {
                if (now - lastDiscoChange > 200) { applyColor(new THREE.Color().setHSL(Math.random(), 1, 0.5), 1, 2); lastDiscoChange = now; }
            } else if (currentEffect === 'fade') {
                const fade = (Math.sin(now * 0.002) + 1) / 2; applyColor(baseColor, 0.2 + fade * 0.8, fade * 3);
            } else if (currentEffect === 'police') {
                const isRed = Math.floor(now / 400) % 2 === 0; applyColor(isRed ? new THREE.Color(1, 0, 0) : new THREE.Color(0, 0, 1), 1, 2);
            } else if (currentEffect === 'xmas') {
                const isRed = Math.floor(now / 1000) % 2 === 0; applyColor(isRed ? new THREE.Color(1, 0, 0) : new THREE.Color(0, 1, 0), 0.9, 2);
            } else if (currentEffect === 'thunder') {
                if (Math.random() > 0.96) { applyColor(new THREE.Color(1, 1, 1), 1, 5); } else { applyColor(new THREE.Color(0.1, 0.1, 0.3), 0.2, 0); }
            } else if (currentEffect === 'sos') {
                const cycle = now % 6000; let isOn = false;
                if (cycle < 1500) isOn = Math.floor(cycle / 250) % 2 === 0; else if (cycle > 2000 && cycle < 4250) isOn = Math.floor((cycle-2000) / 750) % 2 === 0; else if (cycle > 4750) isOn = Math.floor((cycle-4750) / 250) % 2 === 0;
                applyColor(new THREE.Color(1, 0, 0), isOn ? 1 : 0.1, isOn ? 3 : 0);
            } else if (currentEffect === 'france') {
                const t = (now % 3000) / 3000; let color = new THREE.Color();
                if (t < 0.33) { color.lerpColors(new THREE.Color(0x0055A4), new THREE.Color(0xFFFFFF), t/0.33); } else if (t < 0.66) { color.lerpColors(new THREE.Color(0xFFFFFF), new THREE.Color(0xEF4135), (t-0.33)/0.33); } else { color.lerpColors(new THREE.Color(0xEF4135), new THREE.Color(0x0055A4), (t-0.66)/0.34); }
                applyColor(color, 1, 2);
            } else if (currentEffect === 'brazil') {
                const phase = Math.floor((now % 3000) / 1000); let c = phase === 0 ? new THREE.Color(0,1,0) : (phase === 1 ? new THREE.Color(1,1,0) : new THREE.Color(0,0,1));
                applyColor(c, 1, 2);
            } else if (currentEffect === 'halloween') {
                const isOrange = Math.floor(now / 1000) % 2 === 0; applyColor(isOrange ? new THREE.Color(1, 0.5, 0) : new THREE.Color(0.5, 0, 1), 1, 2);
            } else if (currentEffect === 'ice') {
                const t = (Math.sin(now * 0.002) + 1) / 2; applyColor(new THREE.Color().lerpColors(new THREE.Color(1,1,1), new THREE.Color(0, 1, 1), t), 0.8, 2);
            } else if (currentEffect === 'candy') {
                const hue = (now % 5000) / 5000; applyColor(new THREE.Color().setHSL(hue, 0.8, 0.7), 1, 2);
            } else if (currentEffect === 'aurora') {
                const t = (Math.sin(now * 0.001) + 1) / 2; applyColor(new THREE.Color().lerpColors(new THREE.Color(0x00ffaa), new THREE.Color(0xaa00ff), t), 0.8, 2);
            } else if (currentEffect === 'sunset') {
                const t = (Math.sin(now * 0.001) + 1) / 2; applyColor(new THREE.Color().lerpColors(new THREE.Color(0xffcc33), new THREE.Color(0xcc3300), t), 0.9, 2);
            }
            
            if(flagMesh) {
                const time = Date.now() * 0.008; 
                const position = flagMesh.geometry.attributes.position;
                for(let i=0; i < position.count; i++) {
                    const x = position.getX(i);
                    position.setZ(i, Math.sin(x * 1.5 - time) * (x * 0.25));
                }
                position.needsUpdate = true;
            }
            renderer.render(scene, camera);
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>